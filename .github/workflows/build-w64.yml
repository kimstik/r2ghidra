name: Build Windows (MSVC)

on:
  push:
    branches: [w64]
  pull_request:
    branches: [w64]
  workflow_dispatch:

env:
  R2V: 6.0.8

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            vcpkg_triplet: x64-windows
            r2_suffix: w64
          - arch: x86
            vcpkg_triplet: x86-windows
            r2_suffix: w32
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Install build tools
        run: pip install ninja meson wget

      # - name: Install zlib via vcpkg
      #   run: vcpkg install zlib:${{ matrix.vcpkg_triplet }}

      - name: Download radare2
        shell: bash
        run: |
          python -m wget https://github.com/radareorg/radare2/releases/download/${{env.R2V}}/radare2-${{env.R2V}}-${{ matrix.r2_suffix }}.zip -o r2.zip
          unzip r2.zip
          mv radare2-${{env.R2V}}-${{ matrix.r2_suffix }} r2-sdk

      - name: Configure
        shell: cmd
        run: |
          set PKG_CONFIG_PATH=%CD%\r2-sdk\lib\pkgconfig
          set PATH=%CD%\r2-sdk\bin;%PATH%
          rem meson setup build --buildtype=release -Ddefault_library=shared --cmake-prefix-path=C:\vcpkg\installed\${{ matrix.vcpkg_triplet }}
          meson setup build --buildtype=release -Ddefault_library=shared

      - name: Build
        run: meson compile -C build core_r2ghidra

      - name: Package
        shell: bash
        run: |
          mkdir -p artifact
          if [ -f "build/core_r2ghidra.dll" ]; then
            cp build/core_r2ghidra.dll artifact/
            ls -la artifact/
          else
            echo "ERROR: core_r2ghidra.dll not found!"
            find build -name "*.dll" 2>/dev/null
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: r2ghidra-${{ matrix.r2_suffix }}-${{ github.sha }}
          path: artifact/*.dll
          if-no-files-found: error
